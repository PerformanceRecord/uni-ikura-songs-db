<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>é›²ä¸¹ã‚ãã‚‰æ­Œå”±æ›²DB</title>

  <!-- é€Ÿåº¦å¯¾ç­–ï¼šDNSãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ & ãƒ—ãƒ¬ã‚³ãƒã‚¯ãƒˆï¼ˆgoogleusercontent ã‚‚è¿½åŠ ï¼‰ -->
  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin>

  <style>
    :root{
      --bg:#ffb744; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#ffe0b5; --focus:#3897c9; --chip-bg:#f3f4f6; --chip-text:#111827;
      --link:#2563eb; --pill-bg:#f6f7f9;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7;margin:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}

    .row{display:flex;gap:8px;align-items:center}
    .row .search{flex:1 1 auto;min-width:0}

    .toolbar{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-top:8px;flex-wrap:wrap}
    .limit-wrap{display:flex;align-items:center;gap:6px}
    .limit-wrap label{font-size:12px;color:var(--muted);white-space:nowrap}
    #limit{width:auto;min-width:68px;padding:6px 8px;font-size:13px;line-height:1.2}

    /* å¼¾å¹•UI */
    .dm-wrap{display:flex;align-items:center;gap:8px;margin-top:8px}
    .dm-select-wrap{flex:7 1 0}
    .dm-btn-wrap{flex:3 1 0;display:flex}
    #dm-select{width:100%;padding:6px 10px;font-size:14px;line-height:1.2}
    .btn-full{width:100%}

    input[type="search"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff;color:var(--text);outline:none}
    input[type="search"]:focus,select:focus,.btn:focus,.btn-pill:focus{outline:3px solid var(--focus);outline-offset:2px}

    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer;white-space:nowrap}
    .btn:hover{background:#f9fafb}.btn:active{transform:translateY(1px)}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .2s ease}
    .toast.show{opacity:1}

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}
    /* åˆ—å¹…ï¼šæ“ä½œåˆ—ã¯ç”»é¢ã«å¿œã˜ã¦å¯å¤‰ï¼ˆé€”ä¸­æŠ˜ã‚Œé˜²æ­¢ã¨ã®ä¸¡ç«‹ï¼‰ */
    th:nth-child(1),td:nth-child(1){width:26%}
    th:nth-child(2),td:nth-child(2){width:38%}
    th:nth-child(3),td:nth-child(3){width:clamp(28%, 36%, 40%)}

    .ops{
      display:flex;align-items:center;gap:8px;
      justify-content:flex-start;
      flex-wrap:wrap;
      overflow:visible; /* è¦‹åˆ‡ã‚Œé˜²æ­¢ */
      min-width:0;
    }
    .ops > *{white-space:nowrap;flex:0 0 auto}
    .ops .btn-pill, .ops .btn{font-size:11pt}

    .btn-pill{
      display:inline-block;border:1px solid var(--line);background:var(--pill-bg);color:var(--link);
      border-radius:10px;padding:8px 12px;line-height:1.2;text-decoration:none;
      white-space:nowrap;
      word-break:keep-all;       /* æ—¥æœ¬èªã®é€”ä¸­æ”¹è¡Œã‚’é˜²ã */
      max-width:unset;           /* PCã¯ä¸Šé™è§£é™¤ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã¯å¾Œè¿°ã§åˆ¶é™ï¼‰ */
      overflow:hidden;text-overflow:ellipsis
    }
    .btn-pill:hover{background:#eef2f7;text-decoration:none}
    .btn-pill:active{transform:translateY(1px)}

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */
    .skeleton{height:16px;background:#f1f5f9;border-radius:6px;margin:8px 0;animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}

    /* ãƒ¢ãƒã‚¤ãƒ« */
    .mobile-list{display:none}
    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{border-bottom:1px solid var(--line);padding:12px 2px;display:flex;flex-direction:column;gap:6px}
      .l1{font-size:16px;line-height:1.6;font-weight:700;display:flex;gap:6px;flex-wrap:wrap}
      .l1 .sep{opacity:.6}
      .l2{display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:nowrap;overflow:hidden}
      .l2 .btn-pill{max-width:40vw} /* ãƒ¢ãƒã‚¤ãƒ«ã¯å¹…ã‚’åˆ¶é™ */
      .btn{padding:8px 12px;font-size:14px}
      .dm-select-wrap{flex:7 1 0}
      .dm-btn-wrap{flex:3 1 0}
    }
  </style>
</head>
<body>

  <!-- æ¤œç´¢UI -->
  <div class="card">
    <div class="row">
      <input class="search" id="q" type="search" placeholder="æ›²åï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢" autocomplete="off">
    </div>

    <div class="toolbar">
      <div class="limit-wrap">
        <label for="limit">ä»¶æ•°</label>
        <select id="limit" aria-label="è¡¨ç¤ºä»¶æ•°">
          <option value="20" selected>20ä»¶</option>
          <option value="50">50ä»¶</option>
          <option value="200">200ä»¶</option>
          <option value="all">å…¨ä»¶</option>
        </select>
      </div>
    </div>

    <!-- å¼¾å¹•UI -->
    <div class="dm-wrap" aria-label="å¼¾å¹•ã‚³ãƒ”ãƒ¼">
      <div class="dm-select-wrap">
        <select id="dm-select" title="å¼¾å¹•ã‚’é¸æŠ">
          <option value="ğŸ£ğŸ§¡ğŸ£ğŸ§¡ğŸ£ğŸ§¡">ğŸ£ğŸ§¡ğŸ£</option>
          <option value="ğŸ£ğŸ§¡ğŸ¶ğŸ£ğŸ§¡ğŸ¶">ğŸ£ğŸ§¡ğŸ¶</option>
        </select>
      </div>
      <div class="dm-btn-wrap">
        <button id="dm-copy" class="btn btn-full" type="button" title="é¸æŠã—ãŸå¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼">ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <div id="table"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /* ===== è¨­å®š ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbxf6Ifxokz6W9w6E1KOwQxapCgpZAR1WE1VPn9MDnMIXLfRuLAqZwx9HyVzMyuC6nITJA/exec';
    const SHEET_KEY = 'perf';
    const INITIAL_FETCH = 200;
    const HARD_LIMIT = 20000;

    const JSONP_TIMEOUT_MS = 6500;
    const SHORT_TRY_MS = 1500;
    const MAX_RETRY = 2;
    const IFRAME_WATCHDOG_MS = 10000; // å¯å¤‰åŒ–ï¼šç’°å¢ƒã«å¿œã˜ã¦ä¼¸ã°ã›ã‚‹

    const state = {
      rows: [], total: 0, fetchedLimit: 0, debounce: null,
      lastReqId: 0, usedIframe: false,
      pendingHandler: null,
      globalTimer: null, shortTimer: null, currentAttempt: 0,
      iframeTimer: null
    };

    /* ===== JSONP ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæœ€æ–°ãƒãƒ³ãƒ‰ãƒ©ã ã‘ã‚’å®Ÿè¡Œï¼‰ ===== */
    window.onGviz = function(payload){
      if (typeof state.pendingHandler === 'function') {
        state.pendingHandler(payload);
      }
    };

    /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
    function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim(); }
    function scheduleSearch(){ clearTimeout(state.debounce); state.debounce = setTimeout(render, 160); }
    function $(id){ return document.getElementById(id); }
    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

    async function copyPair(title, artist){
      const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š' + text);
      }catch{ showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }

    $('dm-copy').addEventListener('click', async ()=>{
      const text = $('dm-select').value || '';
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('å¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }catch{ showToast('å¼¾å¹•ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    });

    function urlFromText(s){
      if(!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/, '') : '';
    }
    function formatYmdLabel(s){
      const m = /^(\d{4})(\d{2})(\d{2})/.exec(String(s||''));
      return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
    }

    /* ===== ã‚¹ã‚±ãƒ«ãƒˆãƒ³ ===== */
    function showSkeleton(){
      const wrap = $('table');
      wrap.innerHTML = '';
      for(let i=0;i<6;i++){
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        wrap.appendChild(sk);
      }
    }
    function clearSkeleton(){ $('table').innerHTML = ''; }

    /* ===== æç”» ===== */
    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      const q = normalize($('q').value || '');
      const raw = $('limit').value;
      const limit = raw === 'all'
        ? Math.min(HARD_LIMIT, state.total || state.rows.length)
        : Math.min(parseInt(raw,10)||20, HARD_LIMIT);
      const limitLabel = raw === 'all' ? 'å…¨ä»¶' : `${limit}ä»¶`;

      let filtered = state.rows;
      if (q) {
        filtered = filtered.filter(([artist, title]) => {
          const a = normalize(artist), t = normalize(title);
          return a.includes(q) || t.includes(q);
        });
      }
      const rows = filtered.slice(0, limit);

      $('status').textContent = q
        ? `${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå…¨${filtered.length}ä»¶ï¼ç·${state.total}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`
        : `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ï¼ˆç·${state.total}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`;

      if (rows.length === 0) {
        hint.textContent = q ? 'è©²å½“ãªã—' : 'æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        listWrap.style.display = 'none';
        return;
      }
      hint.textContent = '';

      if (!isMobile) {
        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const trh = document.createElement('tr');
        ['ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå','æ›²å','æ“ä½œ'].forEach(h=>{ const th=document.createElement('th'); th.textContent=h; trh.appendChild(th); });
        thead.appendChild(trh); table.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
          const tr=document.createElement('tr');

          let td=document.createElement('td'); td.textContent=artist||''; tr.appendChild(td);
          td=document.createElement('td'); td.textContent=title||''; tr.appendChild(td);

          const tdOps=document.createElement('td');
          const ops=document.createElement('div'); ops.className='ops';

          const cHref = cUrl || urlFromText(cText);
          if (cHref) {
            const aC=document.createElement('a');
            aC.href=cHref; aC.target='_blank'; aC.rel='noopener';
            aC.className='btn-pill';
            aC.title=cText||'ãƒªãƒ³ã‚¯';
            aC.textContent=cText||'ãƒªãƒ³ã‚¯';
            ops.appendChild(aC);
          }

          const dHref = dUrl || urlFromText(dText);
          const dLabel = formatYmdLabel(dText);
          if (dHref) {
            const aD=document.createElement('a');
            aD.href=dHref; aD.target='_blank'; aD.rel='noopener';
            aD.className='btn-pill';
            aD.title=dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
            aD.textContent=dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
            ops.appendChild(aD);
          }

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ã‚³ãƒ”ãƒ¼';
          btn.addEventListener('click',()=>copyPair(title,artist));
          ops.appendChild(btn);

          tdOps.appendChild(ops); tr.appendChild(tdOps); tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.appendChild(table);

        $('mblist').style.display = 'none';

      } else {
        rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
          const item=document.createElement('div'); item.className='item';

          const l1=document.createElement('div'); l1.className='l1';
          const a1=document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
          const sep=document.createElement('span'); sep.className='sep'; sep.textContent='/';
          const t1=document.createElement('span'); t1.className='title'; t1.textContent=title||'';
          l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

          const l2=document.createElement('div'); l2.className='l2';

          const cHref = cUrl || urlFromText(cText);
          if (cHref) {
            const aC=document.createElement('a');
            aC.href=cHref; aC.target='_blank'; aC.rel='noopener';
            aC.className='btn-pill';
            aC.title=cText||'ãƒªãƒ³ã‚¯';
            aC.textContent=cText||'ãƒªãƒ³ã‚¯';
            l2.appendChild(aC);
          }

          const dHref = dUrl || urlFromText(dText);
          const dLabel = formatYmdLabel(dText);
          if (dHref) {
            const aD=document.createElement('a');
            aD.href=dHref; aD.target='_blank'; aD.rel='noopener';
            aD.className='btn-pill';
            aD.title=dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
            aD.textContent=dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
            l2.appendChild(aD);
          }

          const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ã‚³ãƒ”ãƒ¼';
          btn.addEventListener('click',()=>copyPair(title,artist));
          l2.appendChild(btn);

          item.appendChild(l1); item.appendChild(l2);
          $('mblist').appendChild(item);
        });

        $('mblist').style.display='block';
      }
    }

    /* ===== JSONP å–å¾—ï¼ˆçŸ­ãƒªãƒˆãƒ©ã‚¤ â†’ æœ€å¾Œã« iframeã€authuser=0 ä»˜ä¸ï¼‰ ===== */
    function jsonpOnce(url, onerror){
      const s=document.createElement('script');
      s.src=url;
      s.async=true;
      s.onerror=onerror;
      document.head.appendChild(s);
    }

    function fetchRows(limit, attempt=0){
      const reqId = ++state.lastReqId;
      state.currentAttempt = attempt;

      const base = API_URL.replace(/\/macros\/u\/\d+\//,'/macros/');
      const url  = `${base}?callback=onGviz&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit,HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      $('status').textContent = attempt===0 ? 'èª­ã¿è¾¼ã¿ä¸­â€¦' : `å†è©¦è¡Œä¸­â€¦ï¼ˆ${attempt}ï¼‰`;
      showSkeleton();

      let settled = false;

      state.pendingHandler = (payload)=>{
        if (settled) return;
        settled = true;

        clearTimeout(state.shortTimer);
        clearTimeout(state.globalTimer);
        clearTimeout(state.iframeTimer);

        try{
          if (!payload || !Array.isArray(payload.rows)) {
            $('status').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰';
            clearSkeleton();
            return;
          }
          const rows = (payload.rows||[])
            .map(r => [
              r.artist || '', r.title || '', r.cText || '', r.dText || '', r.cUrl || '', r.dUrl || ''
            ])
            .filter(([a,b]) => ((a||'')+(b||'')).trim() !== '');

          state.rows = rows;
          // total ã‚’æœ€å„ªå…ˆã€ãªã‘ã‚Œã° matchedã€ãªã‘ã‚Œã° rows.length
          state.total = Number(
            (payload.total ?? null) != null ? payload.total :
            (payload.matched ?? rows.length)
          );

          // æˆåŠŸæ™‚ã®å¾Œå§‹æœ«ã¨çŠ¶æ…‹æ›´æ–°
          const f = document.getElementById('gviz-frame');
          if (f) f.remove();
          state.usedIframe = false;
          clearTimeout(state.iframeTimer);
          state.fetchedLimit = Math.max(state.fetchedLimit || 0, state.rows.length);

          $('status').textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼š${state.rows.length}ä»¶ï¼ˆå…¨${state.total}ä»¶ï¼‰`;
          clearSkeleton();
          render();
        }catch(e){
          console.error(e);
          $('status').textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
          clearSkeleton();
        }
      };

      state.shortTimer = setTimeout(()=>{
        if (settled) return;
        if (attempt < MAX_RETRY) fetchRows(limit, attempt+1);
      }, SHORT_TRY_MS);

      // ã“ã“ã§ settled ã«ã—ãªã„ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’ pendingHandler ã«æµã™ã€‚
      state.globalTimer = setTimeout(()=>{
        if (settled) return;
        tryIframeFallback(limit, reqId, 'jsonp-timeout');
      }, JSONP_TIMEOUT_MS);

      jsonpOnce(url, ()=>{ /* å³æ™‚ã‚¨ãƒ©ãƒ¼ã¯çŸ­ãƒªãƒˆãƒ©ã‚¤ã«å§”è­² */ });
    }

    function tryIframeFallback(limit, reqId, reason){
      if (state.usedIframe) return;
      state.usedIframe = true;
      $('status').textContent = `åˆ¥ãƒ«ãƒ¼ãƒˆã§å–å¾—ä¸­â€¦ï¼ˆ${reason}ï¼‰`;

      const old = document.getElementById('gviz-frame');
      if (old) old.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//,'/macros/');
      // frame=1 ã¯ GAS å´ã§ã€Œè¦ªã¸ postMessage ã™ã‚‹ãƒ–ãƒªãƒƒã‚¸HTMLã€ã‚’è¿”ã™å®Ÿè£…
      const urlFrame = `${base}?frame=1&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit,HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      const f = document.createElement('iframe');
      f.id = 'gviz-frame';
      f.src = urlFrame;
      f.style.display = 'none';
      f.width = 0; f.height = 0; f.tabIndex = -1;
      document.body.appendChild(f);

      // â˜… ã‚¦ã‚©ãƒƒãƒãƒ‰ãƒƒã‚°ï¼šä¸€å®šæ™‚é–“å†…ã« postMessage ãŒæ¥ãªã‘ã‚Œã°å¤±æ•—ã‚’æ˜ç¤ºã—ã€å†è©¦è¡Œå¯èƒ½ã«æˆ»ã™
      clearTimeout(state.iframeTimer);
      state.iframeTimer = setTimeout(()=>{
        $('status').textContent = 'å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆå…¬é–‹è¨­å®š/ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†è©¦è¡Œï¼‰';
        clearSkeleton();
        state.usedIframe = false; // æ¬¡ã®æ“ä½œã§å†åº¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãã‚‹ã‚ˆã†è§£é™¤
      }, IFRAME_WATCHDOG_MS);
    }

    // iframeï¼ˆ?frame=1ï¼‰â†’ postMessage å—ä¿¡
    window.addEventListener('message', (ev)=>{
      const d = ev?.data;
      if (!d || d.type !== 'gviz') return;
      if (typeof state.pendingHandler === 'function') state.pendingHandler(d.payload);
    });

    // åˆå›
    fetchRows(INITIAL_FETCH);

    /* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
    $('q').addEventListener('input', scheduleSearch);
    $('limit').addEventListener('change', ()=>{
      const raw = $('limit').value;
      // â˜… å…¨ä»¶ãŒæœªå–å¾—ã®ã¨ãã®ã¿è¿½åŠ ãƒ•ã‚§ãƒƒãƒ
      if (raw === 'all' && (state.fetchedLimit||0) < (state.total||HARD_LIMIT)) {
        $('status').textContent = 'å…¨ä»¶ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦';
        fetchRows(HARD_LIMIT);
      } else {
        render();
      }
    });

    const mq = window.matchMedia('(max-width: 768px)');
    mq.addEventListener?.('change', render);
    window.addEventListener('resize', render);
  </script>
</body>
</html>
