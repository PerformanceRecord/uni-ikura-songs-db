<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>Èõ≤‰∏π„Çê„Åè„ÇâÊ≠åÂî±Êõ≤DB</title>

  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin>

  <link rel="icon" href="/uni-ikura-songs-db/favicon.ico" sizes="any">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/uni-ikura-songs-db/apple-touch-icon.png" sizes="180x180">

  <style>
    :root{
      --bg:#ffb744; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#ffe0b5; --focus:#3897c9; --pill-bg:#f6f7f9; --link:#2563eb;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7;margin:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .row{display:flex;gap:8px;align-items:center}
    .row .search{flex:1 1 auto;min-width:0}

    .limit-wrap,.type-wrap{display:flex;align-items:center;gap:6px}
    .limit-wrap label,.type-wrap label{font-size:12px;color:var(--muted);white-space:nowrap}
    input[type="search"],select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
      font-size:16px;background:#fff;color:#1a1a1a;outline:none
    }
    input[type="search"]:focus,
    select:focus,
    .btn:focus,
    .btn-pill:focus,
    .show-sort-btn:focus,
    .sort-btn:focus{
      outline:3px solid var(--focus);outline-offset:2px;
    }

    .btn{
      appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;
      padding:8px 12px;font-size:14px;cursor:pointer;white-space:nowrap
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);
      color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .2s ease
    }
    .toast.show{opacity:1}

    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}

    table.stacked{table-layout:auto}
    table.stacked thead th{width:100% !important;white-space:nowrap}
    table.stacked .item-top{background:#fff;border-bottom:none}
    table.stacked .item-ops{background:#fff}
    table.stacked .item-ops td{border-top:none}
    table.stacked .item-top .l1{
      font-size:16px;font-weight:700;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start
    }
    table.stacked .item-top .l1 .sep{opacity:.6}
    table.stacked .item-ops .ops{
      display:flex;gap:8px;align-items:center;justify-content:flex-end;
      flex-wrap:wrap;overflow:visible;min-width:0
    }

    .btn-pill{
      display:inline-block;border:1px solid var(--line);background:var(--pill-bg);color:var(--link);
      border-radius:10px;padding:8px 12px;line-height:1.2;text-decoration:none;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .btn-pill:hover{background:#eef2f7}

    .skeleton{height:16px;background:#f1f5f9;border-radius:6px;margin:8px 0;animation:pulse 1.2s ease-in-out infinite}
    @keyframes pulse{0%{opacity:.6}50%{opacity:1}100%{opacity:.6}}
    @media (prefers-reduced-motion: reduce){ .skeleton{animation:none} .toast{transition:none} }

    /* „É¢„Éê„Ç§„É´ */
    .mobile-list{display:none}
    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{border-bottom:1px solid var(--line);padding:12px 2px;display:flex;flex-direction:column;gap:6px}
      .l1{font-size:16px;font-weight:700;display:flex;gap:6px;flex-wrap:wrap}
      .l1 .sep{opacity:.6}
      .l2{display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:nowrap;overflow:hidden}
      .l2 .btn-pill{max-width:40vw}
    }

    /* UI‰∏¶„ÅπÊõø„Åà„Åæ„Çè„Çä */
    .ui .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .ui .row:first-child{margin-top:0}
    .ui .row1{flex-wrap:nowrap}
    .ui .row1 select{width:auto;min-width:68px;padding:6px 8px;font-size:13px}
    .ui .row1b{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ui .row1b.is-open{display:flex}

    .show-sort-btn{
      border:1px solid var(--line);background:#fff;border-radius:8px;
      padding:6px 10px;font-size:13px;cursor:pointer;white-space:nowrap
    }
    .sort-btn{
      border:1px solid var(--line);background:#fff;border-radius:10px;
      padding:6px 10px;font-size:13px;cursor:pointer;white-space:nowrap
    }
    .sort-btn.is-active{
      border-color:var(--focus);background:rgba(56,151,201,.08);color:#0f172a;font-weight:600
    }

    .dm-wrap{display:flex;align-items:center;gap:8px}
    .dm-select-wrap{flex:7 1 0}
    .dm-btn-wrap{flex:3 1 0;display:flex}
    #dm-select{width:100%;padding:6px 10px;font-size:16px;line-height:1.2}
    .btn-full{width:100%}
  </style>
</head>
<body>

  <div class="card ui">
    <!-- 1ÂàóÁõÆÔºö‰ª∂Êï∞ / ÂØæË±° / ‰∏¶„ÅπÊõø„ÅàË°®Á§∫ -->
    <div class="row row1">
      <div class="limit-wrap">
        <label for="limit">‰ª∂Êï∞</label>
        <select id="limit" aria-label="Ë°®Á§∫‰ª∂Êï∞">
          <option value="20" selected>20‰ª∂</option>
          <option value="50">50‰ª∂</option>
          <option value="200">200‰ª∂</option>
          <option value="all">ÂÖ®‰ª∂</option>
        </select>
      </div>
      <div class="type-wrap">
        <label for="kind">ÂØæË±°</label>
        <select id="kind" aria-label="ÂØæË±°„Éï„Ç£„É´„Çø">
          <option value="all" selected>„Åô„Åπ„Å¶</option>
          <option value="Ê≠å„Å£„Å¶„Åø„Åü">Ê≠å„Å£„Å¶„Åø„Åü</option>
          <option value="„Ç∑„Éß„Éº„Éà">„Ç∑„Éß„Éº„Éà</option>
        </select>
      </div>
      <button id="show-sort" class="show-sort-btn" type="button">Ë°®Á§∫</button>
    </div>

    <!-- 1.5ÂàóÁõÆÔºö‰∏¶„ÅπÊõø„ÅàÔºàÂàùÊúüÈùûË°®Á§∫Ôºâ -->
    <div class="row row1b" id="sort-panel" aria-label="‰∏¶„ÅπÊõø„Åà">
      <button type="button" class="sort-btn" data-sort="artist" id="sort-artist">Ê≠åÊâãÂêçÈ†Ü‚Üë</button>
      <button type="button" class="sort-btn" data-sort="title" id="sort-title">Ê•ΩÊõ≤È†Ü‚Üë</button>
      <button type="button" class="sort-btn" data-sort="date" id="sort-date">ÊäïÁ®øÊó•È†Ü‚Üë</button>
    </div>

    <!-- 2ÂàóÁõÆÔºöÊ§úÁ¥¢ -->
    <div class="row row2">
      <input class="search" id="q" type="search" placeholder="Êõ≤ÂêçÔºè„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÂêç„ÅßÊ§úÁ¥¢" autocomplete="off">
    </div>

    <!-- 3ÂàóÁõÆÔºöÂºæÂπï -->
    <div class="row row3 dm-wrap" aria-label="ÂºæÂπï„Ç≥„Éî„Éº">
      <div class="dm-select-wrap">
        <select id="dm-select" title="ÂºæÂπï„ÇíÈÅ∏Êäû">
          <option value="üç£üß°üç£üß°üç£üß°">üç£üß°üç£</option>
          <option value="üç£üß°üé∂üç£üß°üé∂">üç£üß°üé∂</option>
        </select>
      </div>
      <div class="dm-btn-wrap">
        <button id="dm-copy" class="btn btn-full" type="button">„Ç≥„Éî„Éº</button>
      </div>
    </div>

    <!-- 4ÂàóÁõÆÔºö„Çπ„ÉÜ„Éº„Çø„Çπ -->
    <div class="row row4">
      <div class="muted" id="status" role="status" aria-live="polite">Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶</div>
    </div>
  </div>

  <!-- ÁµêÊûúË°®Á§∫ -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">Ê§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ</div>
    <div id="table" style="display:none;"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü</div>

  <script>
    /* =========================
       1. Ë®≠ÂÆö
       ========================= */
    const API_URL       = 'https://script.google.com/macros/s/AKfycbxf6Ifxokz6W9w6E1KOwQxapCgpZAR1WE1VPn9MDnMIXLfRuLAqZwx9HyVzMyuC6nITJA/exec';
    const SHEET_KEY     = 'perf';
    const INITIAL_FETCH = 250;  // ‚ÜêÂæπÂ∫ï
    const HARD_LIMIT    = 500;  // ‚ÜêÂæπÂ∫ï

    const JSONP_TIMEOUT_MS  = 6500;
    const SHORT_TRY_MS      = 1500;
    const MAX_RETRY         = 2;
    const IFRAME_WATCHDOG_MS= 10000;

    const CACHE_KEY         = 'uni-ikura-songs-cache-v1';

    /* =========================
       2. Áä∂ÊÖã
       ========================= */
    const state = {
      rows: [],
      total: 0,
      fetchedLimit: 0,
      debounce: null,
      lastReqId: 0,
      usedIframe: false,
      pendingHandler: null,
      globalTimer: null,
      shortTimer: null,
      iframeTimer: null,
      iframeReqId: null,
      sort: {
        key: 'artist',  // artist | title | date
        dir: 1,         // 1=ASC, -1=DESC
        panel: false
      }
    };

    /* =========================
       3. „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
       ========================= */
    function $(id){ return document.getElementById(id); }

    function setStatus(text, opts={}) {
      const el=$('status'); if (!el) return;
      el.textContent = text;
      if (opts.fallback) el.dataset.fallback = '1'; else delete el.dataset.fallback;
    }
    function clearFallbackFlag(){
      const el=$('status'); if (el) delete el.dataset.fallback;
    }

    // localStorage
    function saveCache(rows, total){
      try {
        localStorage.setItem(CACHE_KEY, JSON.stringify({
          rows, total, ts: Date.now()
        }));
      } catch(_) {}
    }
    function loadCache(maxAgeMs = 24*60*60*1000){
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.rows)) return null;
        if (typeof obj.ts === 'number' && Date.now() - obj.ts > maxAgeMs) return null;
        return obj;
      } catch(_) { return null; }
    }

    function normalize(s){
      return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim();
    }

    function showToast(msg){
      const t=$('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1400);
    }

    function urlFromText(s){
      if(!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/, '') : '';
    }

    function safeHttpUrl(u){
      if (!u) return '';
      try {
        const url = new URL(String(u));
        return (url.protocol === 'http:' || url.protocol === 'https:') ? url.href : '';
      } catch(_) { return ''; }
    }

    function formatYmdLabel(s){
      const m=/^(\d{4})(\d{2})(\d{2})/.exec(String(s||''));
      return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
    }

    // DÂàóÊñáÂ≠óÂàó„Åã„Çâ yyyymmdd „ÇíÊäú„ÅçÂá∫„ÅóÊï∞ÂÄ§ÂåñÔºà„Éè„Ç§„Éë„Éº„É™„É≥„ÇØ„Å§„Åç„Éª„Å™„Åó‰∏°ÂØæÂøúÔºâ
    function toSortableDate(dText){
      if (!dText) return 0;
      const digits = String(dText).replace(/\D/g,'');
      if (digits.length < 8) return 0;
      return Number(digits.slice(0,8)); // yyyymmdd
    }

    // Ê§úÁ¥¢„ÅÆ„Éá„Éê„Ç¶„É≥„Çπ„ÇíÂ∞ë„Åó„Å†„ÅëÈï∑„Åè
    function scheduleSearch(){
      clearTimeout(state.debounce);
      state.debounce = setTimeout(render, 240);
    }

    // „Çπ„Ç±„É´„Éà„É≥
    function showSkeleton(){
      const wrap = $('table');
      wrap.innerHTML = '';
      for (let i=0;i<6;i++){
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        wrap.appendChild(sk);
      }
    }
    function clearSkeleton(){ $('table').innerHTML=''; }

    // kind ÂÆâÂÖ®ÂèñÂæó
    function getKindValue(){
      const el = $('kind');
      return el ? el.value : 'all';
    }

    /* =========================
       4. ÊèèÁîª„Éò„É´„Éë
       ========================= */
    function buildDesktopRows(tbody, rows){
      rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
        // ‰∏äÊÆµ
        const trTop = document.createElement('tr'); trTop.className='item-top';
        const tdTop = document.createElement('td'); tdTop.style.borderBottom='none';
        const l1 = document.createElement('div'); l1.className='l1';

        const a1 = document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
        const sep = document.createElement('span'); sep.className='sep'; sep.textContent='/';
        const t1 = document.createElement('span'); t1.className='title'; t1.textContent=title||'';

        l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);
        tdTop.appendChild(l1); trTop.appendChild(tdTop);
        tbody.appendChild(trTop);

        // ‰∏ãÊÆµÔºàÊìç‰ΩúÔºâ
        const trOps = document.createElement('tr'); trOps.className='item-ops';
        const tdOps = document.createElement('td'); tdOps.style.borderTop='none';
        const ops   = document.createElement('div'); ops.className='ops';

        const cHref = safeHttpUrl(cUrl) || safeHttpUrl(urlFromText(cText));
        if (cHref){
          const aC = document.createElement('a');
          aC.href = cHref; aC.target='_blank'; aC.rel='noopener noreferrer';
          aC.className='btn-pill';
          aC.title = cText || '„É™„É≥„ÇØ';
          aC.textContent = cText || '„É™„É≥„ÇØ';
          ops.appendChild(aC);
        }

        const dHref = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
        const dLabel = formatYmdLabel(dText);
        if (dHref){
          const aD = document.createElement('a');
          aD.href = dHref; aD.target='_blank'; aD.rel='noopener noreferrer';
          aD.className='btn-pill';
          aD.title = dLabel ? `ÂâçÂõû ${dLabel}` : 'ÂâçÂõû';
          aD.textContent = dLabel ? `‚ñ∂ÂâçÂõû${dLabel}` : '‚ñ∂ÂâçÂõû';
          ops.appendChild(aD);
        }

        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='„Ç≥„Éî„Éº';
        btn.addEventListener('click', ()=>copyPair(title, artist));
        ops.appendChild(btn);

        tdOps.appendChild(ops); trOps.appendChild(tdOps); tbody.appendChild(trOps);
      });
    }

    function buildMobileRows(listWrap, rows){
      rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
        const item = document.createElement('div'); item.className='item';

        const l1   = document.createElement('div'); l1.className='l1';
        const a1   = document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
        const sep  = document.createElement('span'); sep.className='sep'; sep.textContent='/';
        const t1   = document.createElement('span'); t1.className='title'; t1.textContent=title||'';
        l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

        const l2   = document.createElement('div'); l2.className='l2';

        const cHref = safeHttpUrl(cUrl) || safeHttpUrl(urlFromText(cText));
        if (cHref){
          const aC = document.createElement('a');
          aC.href = cHref; aC.target='_blank'; aC.rel='noopener noreferrer';
          aC.className='btn-pill';
          aC.title = cText || '„É™„É≥„ÇØ';
          aC.textContent = cText || '„É™„É≥„ÇØ';
          l2.appendChild(aC);
        }

        const dHref = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
        const dLabel = formatYmdLabel(dText);
        if (dHref){
          const aD = document.createElement('a');
          aD.href = dHref; aD.target='_blank'; aD.rel='noopener noreferrer';
          aD.className='btn-pill';
          aD.title = dLabel ? `ÂâçÂõû ${dLabel}` : 'ÂâçÂõû';
          aD.textContent = dLabel ? `‚ñ∂ÂâçÂõû${dLabel}` : '‚ñ∂ÂâçÂõû';
          l2.appendChild(aD);
        }

        const btn = document.createElement('button'); btn.className='btn'; btn.textContent='„Ç≥„Éî„Éº';
        btn.addEventListener('click', ()=>copyPair(title, artist));
        l2.appendChild(btn);

        item.appendChild(l1); item.appendChild(l2);
        listWrap.appendChild(item);
      });
    }

    /* =========================
       5. „É°„Ç§„É≥ÊèèÁîª
       ========================= */
    function render(){
      clearFallbackFlag();

      const tableWrap = $('table'); tableWrap.innerHTML='';
      const listWrap  = $('mblist'); listWrap.innerHTML='';
      const hint      = $('hint');

      tableWrap.style.display='none';
      listWrap.style.display='none';

      const isMobile  = window.matchMedia('(max-width: 768px)').matches;
      const q         = normalize($('q').value || '');
      const rawLimit  = $('limit').value;
      const kind      = getKindValue();

      const limit = rawLimit === 'all'
        ? Math.min(HARD_LIMIT, state.total || state.rows.length)
        : Math.min(parseInt(rawLimit,10) || 20, HARD_LIMIT);
      const limitLabel = rawLimit === 'all' ? 'ÂÖ®‰ª∂' : `${limit}‰ª∂`;

      // 1) „Éï„Ç£„É´„Çø
      let filtered = state.rows;

      if (q) {
        filtered = filtered.filter(([artist, title])=>{
          const a = normalize(artist), t = normalize(title);
          return a.includes(q) || t.includes(q);
        });
      }
      if (kind !== 'all') {
        filtered = filtered.filter(([, , cText])=> String(cText || '').trim() === kind);
      }

      // 2) ‰∏¶„ÅπÊõø„Åà
      const { key, dir } = state.sort;
      filtered = filtered.slice().sort((r1, r2)=>{
        if (key === 'artist'){
          return (r1[0]||'').localeCompare((r2[0]||''), 'ja') * dir;
        }
        if (key === 'title'){
          return (r1[1]||'').localeCompare((r2[1]||''), 'ja') * dir;
        }
        // date
        let v1 = toSortableDate(r1[3] || '');
        let v2 = toSortableDate(r2[3] || '');
        if (v1 === 0 && r1[5]) v1 = toSortableDate(r1[5]);
        if (v2 === 0 && r2[5]) v2 = toSortableDate(r2[5]);
        return (v1 - v2) * dir;
      });

      const rows = filtered.slice(0, limit);

      setStatus(
        (q || kind !== 'all')
          ? `Ë°®Á§∫‰∏≠ ${rows.length}‰ª∂„Éí„ÉÉ„ÉàÔºàÂØæË±°${filtered.length}‰ª∂Ôºè${state.total}‰ª∂ÔºâÔºèË°®Á§∫‰∏äÈôê ${limitLabel}`
          : `Ë°®Á§∫‰∏≠ ${rows.length}‰ª∂„Éí„ÉÉ„ÉàÔºàÂÖ®${state.total}‰ª∂ÔºâÔºèË°®Á§∫‰∏äÈôê ${limitLabel}`
      );

      if (rows.length === 0){
        hint.textContent = (q || kind !== 'all') ? 'Ë©≤ÂΩì„Å™„Åó' : 'Ê§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ';
        return;
      }
      hint.textContent = '';

      if (!isMobile){
        const table = document.createElement('table');
        table.className='stacked';
        const thead = document.createElement('thead');
        const trh   = document.createElement('tr');
        const th    = document.createElement('th');
        th.textContent='„Ç¢„Éº„ÉÜ„Ç£„Çπ„ÉàÔºèÊ•ΩÊõ≤ÊÉÖÂ†±';
        trh.appendChild(th); thead.appendChild(trh); table.appendChild(thead);

        const tbody = document.createElement('tbody');
        buildDesktopRows(tbody, rows);
        table.appendChild(tbody);

        tableWrap.appendChild(table);
        tableWrap.style.display='block';
      } else {
        buildMobileRows(listWrap, rows);
        listWrap.style.display='block';
      }
    }

    /* =========================
       6. ÈÄö‰ø°
       ========================= */
    function jsonpOnce(url, onerror, reqId){
      const s=document.createElement('script');
      s.src=url; s.async=true; s.dataset.jsonp=String(reqId||'');
      s.onerror=()=>{ try{ s.remove(); }catch{}; onerror && onerror(); };
      document.head.appendChild(s);
    }
    function cleanupJsonpScripts(reqId){
      const sel = reqId ? `script[data-jsonp="${reqId}"]` : 'script[data-jsonp]';
      document.querySelectorAll(sel).forEach(el=>{ try{ el.remove(); }catch{} });
    }

    function fetchRows(limit, attempt=0){
      const reqId = ++state.lastReqId;

      // ÊóßiframeÊéÉÈô§
      if (state.iframeTimer){
        clearTimeout(state.iframeTimer);
        state.iframeTimer = null;
        state.iframeReqId = null;
      }
      const prev = document.getElementById('gviz-frame');
      if (prev) prev.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//,'/macros/');
      const url  = `${base}?callback=onGviz&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit,HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      setStatus(attempt===0 ? 'Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶' : `Ë™≠„ÅøËæº„Åø‰∏≠‚Ä¶Ôºà${attempt}Ôºâ`);
      showSkeleton();

      let settled = false;

      state.pendingHandler = (payload)=>{
        clearFallbackFlag();
        if (settled) return;
        if (reqId !== state.lastReqId) return;
        settled = true;

        clearTimeout(state.shortTimer);
        clearTimeout(state.globalTimer);

        try{
          if (!payload || !Array.isArray(payload.rows)){
            setStatus('„Éá„Éº„ÇøÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà‰∏çÊ≠£„Å™„É¨„Çπ„Éù„É≥„ÇπÔºâ');
            cleanupJsonpScripts(reqId);
            clearSkeleton();
            return;
          }

          const rows = (payload.rows || [])
            .map(r => [ r.artist || '', r.title || '', r.cText || '', r.dText || '', r.cUrl || '', r.dUrl || '' ])
            .filter(([a,b]) => ((a||'')+(b||'')).trim() !== '');

          state.rows = rows;
          state.total = Number(
            (payload.total ?? null) != null ? payload.total :
            (payload.matched ?? rows.length)
          );

          // iframeÊéÉÈô§
          const f = document.getElementById('gviz-frame');
          if (f) f.remove();
          state.usedIframe = false;
          if (state.iframeReqId === reqId && state.iframeTimer) {
            clearTimeout(state.iframeTimer);
          }
          state.iframeTimer = null;
          state.iframeReqId = null;

          cleanupJsonpScripts(reqId);
          state.fetchedLimit = Math.max(state.fetchedLimit || 0, state.rows.length);

          // Âèñ„Çå„Åü„Çâ„Ç≠„É£„ÉÉ„Ç∑„É•
          saveCache(state.rows, state.total);

          setStatus(`Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÔºö${state.rows.length}‰ª∂ÔºàÂÖ®${state.total}‰ª∂Ôºâ`);
          clearSkeleton();
          render();
        }catch(e){
          console.error(e);
          setStatus('Ë™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
          cleanupJsonpScripts(reqId);
          clearSkeleton();
        }
      };

      // Áü≠ÊôÇÈñì„É™„Éà„É©„Ç§
      state.shortTimer = setTimeout(()=>{
        if (!settled && attempt < MAX_RETRY){
          fetchRows(limit, attempt+1);
        }
      }, SHORT_TRY_MS);

      // JSONPÂÖ®‰Ωì„Çø„Ç§„É†„Ç¢„Ç¶„Éà
      state.globalTimer = setTimeout(()=>{
        if (!settled && reqId === state.lastReqId) {
          tryIframeFallback(limit, reqId, 'jsonp-timeout');
        }
      }, JSONP_TIMEOUT_MS);

      jsonpOnce(url, ()=>{}, reqId);
    }

    function tryIframeFallback(limit, reqId, reason){
      if (reqId !== state.lastReqId) return;
      if ((state.rows && state.rows.length) > 0) return;
      if (state.usedIframe) return;
      state.usedIframe = true;

      setStatus(`Âà•„É´„Éº„Éà„ÅßÂèñÂæó‰∏≠‚Ä¶Ôºà${reason}Ôºâ`, {fallback:true});

      const base = API_URL.replace(/\/macros\/u\/\d+\//,'/macros/');
      const urlFrame = `${base}?frame=1&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit,HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      const f = document.createElement('iframe');
      f.id = 'gviz-frame';
      f.src = urlFrame;
      f.style.display = 'none';
      f.width = 0; f.height = 0; f.tabIndex = -1;
      document.body.appendChild(f);

      state.iframeReqId = reqId;
      state.iframeTimer = setTimeout(()=>{
        if (state.lastReqId !== reqId) return;
        if (!$('status')?.dataset?.fallback) return;
        if ((state.rows && state.rows.length) > 0) return;

        setStatus('ÂèñÂæó„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„ÅüÔºàÂÖ¨ÈñãË®≠ÂÆö/„Éá„Éó„É≠„Ç§Á¢∫Ë™ç„Éª„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂÜçË©¶Ë°åÔºâ');
        const g = document.getElementById('gviz-frame'); if (g) g.remove();
        state.usedIframe = false;
        clearSkeleton();
      }, IFRAME_WATCHDOG_MS);
    }

    // JSONP„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÁµåË∑ØÔºàiframeÔºâ
    window.addEventListener('message', (ev)=>{
      const d = ev?.data;
      if (!d || d.type !== 'gviz') return;
      clearFallbackFlag();
      if (typeof state.pendingHandler === 'function') state.pendingHandler(d.payload);
    });

    /* =========================
       7. „Ç§„Éô„É≥„Éà & ÂàùÊúüÂåñ
       ========================= */

    // Ê§úÁ¥¢
    $('q').addEventListener('input', scheduleSearch);

    // ‰ª∂Êï∞Â§âÊõ¥
    $('limit').addEventListener('change', ()=>{
      const raw = $('limit').value;
      if (raw === 'all') {
        // „Åæ„Å†ÂÖ®ÈÉ®Âèñ„Å£„Å¶„Å™„ÅÑ & ÂÖ®‰ª∂„ÅÆÊñπ„ÅåÂ§ö„ÅÑ„Å®„Åç„Å†„Åë500„ÇíÂèñ„Çä„Å´Ë°å„Åè
        if ((state.fetchedLimit || 0) < HARD_LIMIT && (state.total || 0) > (state.fetchedLimit || 0)) {
          setStatus('ÂÖ®‰ª∂„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô‚Ä¶');
          fetchRows(HARD_LIMIT);
        } else {
          render();
        }
      } else {
        render();
      }
    });

    // ÂØæË±°Â§âÊõ¥
    $('kind').addEventListener('change', render);

    // ‰∏¶„ÅπÊõø„ÅàË°®Á§∫
    (function(){
      const btn = $('show-sort');
      const panel = $('sort-panel');
      btn.addEventListener('click', ()=>{
        state.sort.panel = !state.sort.panel;
        if (state.sort.panel){
          panel.classList.add('is-open');
          btn.textContent='ÈùûË°®Á§∫';
        } else {
          panel.classList.remove('is-open');
          btn.textContent='Ë°®Á§∫';
        }
      });
    })();

    // ‰∏¶„ÅπÊõø„Åà„Éú„Çø„É≥
    (function(){
      const btnArtist = $('sort-artist');
      const btnTitle  = $('sort-title');
      const btnDate   = $('sort-date');

      function updateSortButtons(){
        const { key, dir } = state.sort;
        const map = {
          artist: btnArtist,
          title:  btnTitle,
          date:   btnDate
        };
        Object.entries(map).forEach(([k, b])=>{
          if (k === key){
            b.classList.add('is-active');
            if (k === 'artist') b.textContent = dir === 1 ? 'Ê≠åÊâãÂêçÈ†Ü‚Üë' : 'Ê≠åÊâãÂêçÈ†Ü‚Üì';
            if (k === 'title')  b.textContent = dir === 1 ? 'Ê•ΩÊõ≤È†Ü‚Üë'   : 'Ê•ΩÊõ≤È†Ü‚Üì';
            if (k === 'date')   b.textContent = dir === 1 ? 'ÊäïÁ®øÊó•È†Ü‚Üë' : 'ÊäïÁ®øÊó•È†Ü‚Üì';
          } else {
            b.classList.remove('is-active');
            if (k === 'artist') b.textContent = 'Ê≠åÊâãÂêçÈ†Ü‚Üë';
            if (k === 'title')  b.textContent = 'Ê•ΩÊõ≤È†Ü‚Üë';
            if (k === 'date')   b.textContent = 'ÊäïÁ®øÊó•È†Ü‚Üë';
          }
        });
      }

      function toggleSort(target){
        if (state.sort.key === target){
          state.sort.dir *= -1;
        } else {
          state.sort.key = target;
          state.sort.dir = 1;
        }
        updateSortButtons();
        render();
      }

      btnArtist.addEventListener('click', ()=>toggleSort('artist'));
      btnTitle.addEventListener('click',  ()=>toggleSort('title'));
      btnDate.addEventListener('click',   ()=>toggleSort('date'));

      updateSortButtons();
    })();

    // ÁîªÈù¢„Çµ„Ç§„Ç∫Â§âÂåñ
    const mq = window.matchMedia('(max-width: 768px)');
    mq.addEventListener?.('change', render);
    window.addEventListener('resize', render);

    // „Ç™„É≥„É©„Ç§„É≥/„Ç™„Éï„É©„Ç§„É≥
    window.addEventListener('offline', ()=>{
      setStatus('„Ç™„Éï„É©„Ç§„É≥„Åß„Åô„ÄÇÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
    });
    window.addEventListener('online', ()=>{
      setStatus('„Ç™„É≥„É©„Ç§„É≥„Å´Âæ©Â∏∞„Åó„Åæ„Åó„Åü„ÄÇÂÜçÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô‚Ä¶');
      fetchRows(INITIAL_FETCH);
    });

    // „Çø„ÉñÂæ©Â∏∞ÊôÇ
    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible') {
        if ($('status')?.dataset?.fallback && (state.rows && state.rows.length)>0) {
          clearFallbackFlag();
        }
      }
    });

    // ÂàùÊúüË°®Á§∫Ôºö„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÂÑ™ÂÖà„Åó„ÄÅ„Åù„ÅÆÂæå„Çµ„Éº„Éê„Éº„Å∏
    const cached = loadCache();
    if (cached){
      state.rows = cached.rows;
      state.total = cached.total || cached.rows.length;
      state.fetchedLimit = state.rows.length;
      render();
      setStatus('„Ç≠„É£„ÉÉ„Ç∑„É•„Åã„ÇâË°®Á§∫„Åó„Åæ„Åó„Åü„ÄÇÊúÄÊñ∞„Éá„Éº„ÇøÂèñÂæó‰∏≠‚Ä¶');
    }
    // „Çµ„Éº„Éê„Éº„Åã„ÇâÊúÄÊñ∞„ÇíÂèñÂæóÔºà250‰ª∂Ôºâ
    fetchRows(INITIAL_FETCH);

    console.log('UI layout (Êï¥ÁêÜÁâà) with cache, sort, debounce240, INITIAL=250, HARD=500');
  </script>
</body>
</html>
